<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Water Comparison Analysis</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <%- include('partials/navbar') %>

<div class="max-w-7xl mx-auto px-4 py-12">
  <h1 class="text-4xl font-bold text-gray-900 mb-2">Water Comparison Analysis</h1>
  <p class="text-gray-600 mb-8">Detailed segmentation and change analysis</p>

  <!-- Back Button -->
  <a href="/upload" class="inline-block mb-6 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
    ← Back to Gallery
  </a>

  <!-- Before Section -->
  <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-8">
    <h2 class="text-2xl font-bold text-gray-900 bg-blue-50 p-6">Before Image Analysis</h2>
    
    <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
      <div>
        <p class="text-sm font-semibold text-gray-700 mb-2">Original Satellite Image</p>
        <img id="preOriginal" class="w-full h-64 object-cover rounded-lg bg-gray-100" onerror="this.style.backgroundColor='#e5e7eb'" />
      </div>
      
      <div>
        <p class="text-sm font-semibold text-gray-700 mb-2">Binary Water Mask</p>
        <img id="preMask" class="w-full h-64 object-cover rounded-lg bg-gray-100" onerror="this.style.backgroundColor='#e5e7eb'" />
      </div>
      
      <div>
        <p class="text-sm font-semibold text-gray-700 mb-2">Segmented Overlay</p>
        <img id="preMasked" class="w-full h-64 object-cover rounded-lg bg-gray-100" onerror="this.style.backgroundColor='#e5e7eb'" />
      </div>
    </div>

    <!-- Before Statistics -->
    <div class="bg-gradient-to-r from-blue-50 to-cyan-50 p-6 border-t">
      <h3 class="text-lg font-bold text-gray-900 mb-4">Before Statistics</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-white rounded p-4 shadow-sm">
          <p class="text-xs text-gray-600 uppercase tracking-wide">Total Pixels</p>
          <p class="text-2xl font-bold text-gray-900 mt-1" id="preTotalPixels">-</p>
        </div>
        <div class="bg-white rounded p-4 shadow-sm">
          <p class="text-xs text-gray-600 uppercase tracking-wide">Water Pixels</p>
          <p class="text-2xl font-bold text-blue-600 mt-1" id="preFloodPixels">-</p>
        </div>
        <div class="bg-white rounded p-4 shadow-sm">
          <p class="text-xs text-gray-600 uppercase tracking-wide">Water Coverage</p>
          <p class="text-2xl font-bold text-blue-700 mt-1" id="preFloodPercent">-</p>
        </div>
        <div class="bg-white rounded p-4 shadow-sm">
          <p class="text-xs text-gray-600 uppercase tracking-wide">Processing Time</p>
          <p class="text-2xl font-bold text-gray-900 mt-1" id="preProcessingTime">-</p>
        </div>
      </div>
      <div class="mt-4">
        <p class="text-sm text-gray-600 mb-2">Water Coverage Bar</p>
        <div class="w-full bg-gray-200 rounded-full h-4">
          <div id="preBar" class="bg-blue-600 h-4 rounded-full" style="width: 0%"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Change Analysis -->
  <div class="bg-gradient-to-br from-orange-50 to-red-50 rounded-lg shadow-lg p-8 mb-8 border-l-4 border-orange-500">
    <h2 class="text-2xl font-bold text-gray-900 mb-4">Water Change Analysis</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="text-center">
        <p class="text-sm text-gray-600 uppercase tracking-wide mb-2">Change in Pixels</p>
        <p class="text-3xl font-bold text-orange-600" id="changePixels">-</p>
      </div>
      <div class="text-center">
        <p class="text-sm text-gray-600 uppercase tracking-wide mb-2">Change Percentage</p>
        <p class="text-4xl font-bold text-red-600" id="changePercent">-</p>
      </div>
      <div class="text-center">
        <p class="text-sm text-gray-600 uppercase tracking-wide mb-2">Interpretation</p>
        <p class="text-lg font-semibold text-gray-900 mt-2" id="interpretation">-</p>
      </div>
    </div>
  </div>

  <!-- After Section -->
  <div class="bg-white rounded-lg shadow-lg overflow-hidden">
    <h2 class="text-2xl font-bold text-gray-900 bg-red-50 p-6">After Image Analysis</h2>
    
    <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
      <div>
        <p class="text-sm font-semibold text-gray-700 mb-2">Original Satellite Image</p>
        <img id="postOriginal" class="w-full h-64 object-cover rounded-lg bg-gray-100" onerror="this.style.backgroundColor='#e5e7eb'" />
      </div>
      
      <div>
        <p class="text-sm font-semibold text-gray-700 mb-2">Binary Water Mask</p>
        <img id="postMask" class="w-full h-64 object-cover rounded-lg bg-gray-100" onerror="this.style.backgroundColor='#e5e7eb'" />
      </div>
      
      <div>
        <p class="text-sm font-semibold text-gray-700 mb-2">Segmented Overlay</p>
        <img id="postMasked" class="w-full h-64 object-cover rounded-lg bg-gray-100" onerror="this.style.backgroundColor='#e5e7eb'" />
      </div>
    </div>

    <!-- After Statistics -->
    <div class="bg-gradient-to-r from-red-50 to-orange-50 p-6 border-t">
      <h3 class="text-lg font-bold text-gray-900 mb-4">After Statistics</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-white rounded p-4 shadow-sm">
          <p class="text-xs text-gray-600 uppercase tracking-wide">Total Pixels</p>
          <p class="text-2xl font-bold text-gray-900 mt-1" id="postTotalPixels">-</p>
        </div>
        <div class="bg-white rounded p-4 shadow-sm">
          <p class="text-xs text-gray-600 uppercase tracking-wide">Water Pixels</p>
          <p class="text-2xl font-bold text-red-600 mt-1" id="postFloodPixels">-</p>
        </div>
        <div class="bg-white rounded p-4 shadow-sm">
          <p class="text-xs text-gray-600 uppercase tracking-wide">Water Coverage</p>
          <p class="text-2xl font-bold text-red-700 mt-1" id="postFloodPercent">-</p>
        </div>
        <div class="bg-white rounded p-4 shadow-sm">
          <p class="text-xs text-gray-600 uppercase tracking-wide">Processing Time</p>
          <p class="text-2xl font-bold text-gray-900 mt-1" id="postProcessingTime">-</p>
        </div>
      </div>
      <div class="mt-4">
        <p class="text-sm text-gray-600 mb-2">Water Coverage Bar</p>
        <div class="w-full bg-gray-200 rounded-full h-4">
          <div id="postBar" class="bg-red-600 h-4 rounded-full" style="width: 0%"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Back Button -->
  <div class="text-center mt-12">
    <a href="/upload" class="inline-block px-8 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">
      ← Back to Gallery
    </a>
  </div>
</div>

<script>
  const preImageId = new URLSearchParams(window.location.search).get('preImageId');
  const postImageId = new URLSearchParams(window.location.search).get('postImageId');

  let preData = null;
  let postData = null;

  async function loadData() {
    try {
      // Fetch segmentation data for both images
      const preResponse = await fetch(`/api/images/${preImageId}/segmentation`);
      const preJson = await preResponse.json();
      
      const postResponse = await fetch(`/api/images/${postImageId}/segmentation`);
      const postJson = await postResponse.json();

      if (preJson.success && preJson.data) {
        preData = preJson.data;
      }
      if (postJson.success && postJson.data) {
        postData = postJson.data;
      }

      // Set image sources
      document.getElementById('preOriginal').src = `/api/images/original/${preImageId}`;
      document.getElementById('preMask').src = `/api/images/mask/${preImageId}`;
      document.getElementById('preMasked').src = `/api/images/masked/${preImageId}`;

      document.getElementById('postOriginal').src = `/api/images/original/${postImageId}`;
      document.getElementById('postMask').src = `/api/images/mask/${postImageId}`;
      document.getElementById('postMasked').src = `/api/images/masked/${postImageId}`;

      // Display before statistics
      if (preData) {
        document.getElementById('preTotalPixels').textContent = preData.totalPixels.toLocaleString();
        document.getElementById('preFloodPixels').textContent = preData.floodPixels.toLocaleString();
        document.getElementById('preFloodPercent').textContent = preData.floodPercentage.toFixed(2) + '%';
        document.getElementById('preProcessingTime').textContent = preData.processingTime + 'ms';
        document.getElementById('preBar').style.width = preData.floodPercentage + '%';
      }

      // Display after statistics
      if (postData) {
        document.getElementById('postTotalPixels').textContent = postData.totalPixels.toLocaleString();
        document.getElementById('postFloodPixels').textContent = postData.floodPixels.toLocaleString();
        document.getElementById('postFloodPercent').textContent = postData.floodPercentage.toFixed(2) + '%';
        document.getElementById('postProcessingTime').textContent = postData.processingTime + 'ms';
        document.getElementById('postBar').style.width = postData.floodPercentage + '%';
      }

      // Calculate change
      if (preData && postData) {
        const changePixels = postData.floodPixels - preData.floodPixels;
        const changePercent = ((postData.floodPixels - preData.floodPixels) / preData.floodPixels) * 100;
        const preWaterPercent = preData.floodPercentage;
        const postWaterPercent = postData.floodPercentage;
        const waterIncrease = postWaterPercent - preWaterPercent;
        
        document.getElementById('changePixels').textContent = (changePixels > 0 ? '+' : '') + changePixels.toLocaleString();
        document.getElementById('changePercent').textContent = (waterIncrease > 0 ? '+' : '') + waterIncrease.toFixed(2) + '% water';
        
        let interpretation = '';
        if (waterIncrease > 5) {
          interpretation = `Water coverage increased by ${waterIncrease.toFixed(2)}% (${changePercent.toFixed(1)}% more flood pixels)`;
        } else if (waterIncrease > 0) {
          interpretation = `Water coverage increased by ${waterIncrease.toFixed(2)}%`;
        } else if (waterIncrease < -5) {
          interpretation = `Water coverage decreased by ${Math.abs(waterIncrease).toFixed(2)}% (${Math.abs(changePercent).toFixed(1)}% fewer flood pixels)`;
        } else if (waterIncrease < 0) {
          interpretation = `Water coverage decreased by ${Math.abs(waterIncrease).toFixed(2)}%`;
        } else {
          interpretation = 'No significant water level change';
        }
        document.getElementById('interpretation').textContent = interpretation;
      }
    } catch (error) {
      console.error('Error loading data:', error);
      alert('Error loading comparison data: ' + error.message);
    }
  }

  loadData();
</script>

  <%- include('partials/footer') %>
</body>
</html>
